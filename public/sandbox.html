<html>
  <head>
    <title>NodeKick</title>
    <script src="http://codeorigin.jquery.com/jquery-2.0.3.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
  </head>
  <body>
    <div id="stage" style="width: 320px; height: 320px; margin-top: 100px">
    </div>
    <div id="player" style="width: 50px; height: 50px; border: solid 1px silver"></div>
    <br/>
    <div id="currentX"></div>
    <div id="currentY"></div>
    <input type="button" id="kickLeft" value="kick left" />
    <input type="button" id="jump" value="jump" />
    <input type="button" id="kickRight" value="kick right" />
    <hr />
    <input type="text" id="originX" value="300" />
    <input type="text" id="originY" value="400" /><br />
    <input type="button" id="standBoxR" value="stand box right" /><br />
    <input type="button" id="jumpBoxR" value="jump box right" /><br />
    <input type="button" id="kickBoxR" value="kick box right" /><br />
    <input type="button" id="standBoxL" value="stand box left" /><br />
    <input type="button" id="jumpBoxL" value="jump box left" /><br />
    <input type="button" id="kickBoxL" value="kick box left" /><br />
    <script>
      var player = {
        x: 0, y: 0, dy: 0, s: "s", d: "l",
        boxes: {
          r: {
            s: [
              { x: -10, y: -185, x2: 10, y2: -160 },
              { x: -30, y: -155, x2: 20, y2: -100 },
              { x: -25, y: -100, x2: 17.5, y2: -55 },
              { x: -35, y: -52.5, x2: 30, y2: -17.5 }
            ],
            j: [
              { x: -5, y: -180, x2: 20, y2: -152.5 },
              { x: -18.5, y: -147.5, x2: 14, y2: -97.5 },
              { x: -5, y: -100, x2: 7.5, y2: -12.5 },
              { x: 7.5, y: -85, x2: 25, y2: -67.5 },
              { x: -25, y: -65, x2: 12.5, y2: -55 }
            ],
            k: [
              { x: -10, y: -160, x2: 10, y2: -130 },
              { x: -28.5, y: -135, x2: -3.5, y2: -122.5 },
              { x: -40, y: -120, x2: -5, y2: -100 },
              { x: -35, y: -100, x2: 30, y2: -87.5 },
              { x: -30, y: -90, x2: 20, y2: -77.5 },
              { x: -8.5, y: -75, x2: 6.5, y2: -45 },
              { x: 10, y: -50, x2: 20, y2: -32.5 },
              { x: 25, y: -35, x2: 47.5, y2: -12.5 }
            ]
          },
          l: {
            s: [
              { x: -10, y: -185, x2: 10, y2: -160 },
              { x: -20, y: -155, x2: 30, y2: -100 },
              { x: -17.5, y: -100, x2: 25, y2: -55 },
              { x: -30, y: -52.5, x2: 35, y2: -17.5 }
            ],
            j: [
              { x: -20, y: -180, x2: 5, y2: -152.5 },
              { x: -14, y: -147.5, x2: 18.5, y2: -97.5 },
              { x: -7.5, y: -100, x2: 5, y2: -12.5 },
              { x: -25, y: -85, x2: -7.5, y2: -67.5 },
              { x: -12.5, y: -65, x2: 25, y2: -55 }
            ],
            k: [
              { x: -10, y: -160, x2: 10, y2: -130 },
              { x: 3.5, y: -135, x2: 28.5, y2: -122.5 },
              { x: 5, y: -120, x2: 40, y2: -100 },
              { x: -30, y: -100, x2: 35, y2: -87.5 },
              { x: -20, y: -90, x2: 30, y2: -77.5 },
              { x: -6.5, y: -75, x2: 8.5, y2: -45 },
              { x: -20, y: -50, x2: -10, y2: -32.5 },
              { x: -47.5, y: -35, x2: -25, y2: -12.5 }
            ]
          }
        }
      };

      var currentMousePos = { };
      var lastMousePos = { };

      $(function() {
        $(document).mousemove(function(event) {
          lastMousePos.top = currentMousePos.top;
          lastMousePos.left = currentMousePos.left;
          currentMousePos.top = event.pageY;
          currentMousePos.left = event.pageX;
          $("#currentX").html(event.pageX);
          $("#currentY").html(event.pageY);
        });

        $(document).mouseup(function(event) {
          currentMovingClass = null;
        });

        $(document).click(function() {
          //var screenHeight = 1000;
          //console.log(currentMousePos);
          //drawBoxes("rk", currentMousePos.left, currentMousePos.top, player.boxes.r.k);
        });

        $("#jump").click(function() { jump(player); });
        $("#kickRight").click(function() { kickRight(player); });
        $("#kickLeft").click(function() { kickLeft(player); });
        $("#standBoxR").click(function() { drawBoxes("rs", parseInt($("#originX").val()), parseInt($("#originY").val()), player.boxes.r.s); });
        $("#jumpBoxR").click(function() { drawBoxes("rj", parseInt($("#originX").val()), parseInt($("#originY").val()), player.boxes.r.j); });
        $("#kickBoxR").click(function() { drawBoxes("rk", parseInt($("#originX").val()), parseInt($("#originY").val()), player.boxes.r.k); });
        $("#standBoxL").click(function() { drawBoxes("ls", parseInt($("#originX").val()) + 300, parseInt($("#originY").val()), player.boxes.l.s); });
        $("#jumpBoxL").click(function() { drawBoxes("lj", parseInt($("#originX").val()) + 300, parseInt($("#originY").val()), player.boxes.l.j); });
        $("#kickBoxL").click(function() { drawBoxes("lk", parseInt($("#originX").val()) + 300, parseInt($("#originY").val()), player.boxes.l.k); });
        setInterval(tick, 1000.0/fps);
      });

      function setSquare(x, y) {
        var pos = $("#stage").position();
        var height = 50;
        pos.top = ($("#stage").height() + $("#stage").offset().top) - y - height;
        $("#player").css({ position: "absolute", top: pos.top, left: pos.left + x });
      }

      var fps = 33.0;
      var ticks = 0.0;
      var gravity = 3000;
      var dy = 1200;
      var dkick = 400;

      function applyGravity(player) {
        if(player.s !== "j") return;

        player.dy -= (gravity * (1.0 / fps));
        player.y += player.dy * (1.0 / fps);

        console.log(player.y);

        if(player.y < 0) {
          player.y = 0;
          player.dy = 0;
          player.s = "s";
        }
      }

      function applyKick(player) {
        if(player.s !== "k") return;

        var d = (dkick * (1.0 / fps));
        if(player.d === "r") player.x += d;

        else if(player.d === "l") player.x -= d;

        player.y -= d;

        if(player.y < 0) {
          player.y = 0;
          player.dy = 0;
          player.s = "s";
        }
      }

      function kickRight(player) {
        if(player.s === "j") {
          player.d = "r";
          player.s = "k";
        }
      }

      function kickLeft(player) {
        if(player.s === "j") {
          player.d = "l";
          player.s = "k";
        }
      }

      function isDeath(foot, otherPlayers) {
        var footPoint = foot;
        _.each(otherPlayers, function(player) {
          _.each(player, function(box) {
            if(hasCollision(footPoint, box)) {
              console.log("death");
            }
          });
        });
      }

      function hasCollision(points1, points2) {
        if (points1.x2 < points2.x) return false;
        if (points1.x > points2.x2) return false;
        if (points1.y2 < points2.y) return false;
        if (points1.y > points2.y2) return false;
        return true
      }

      function toPoints(box) {
        return {
          top: box.y,
          left: box.x,
          right: box.x + box.w, 
          bottom: box.y + box.h
        };
      }

      var currentMovingClass = null;
      var allBoxes = { };

      function drawBoxes(c, originX, originY, boxes) {
        var clonedBoxes = JSON.parse(JSON.stringify(boxes));
        _.each(clonedBoxes, function(clonedBox) {
          clonedBox.x += originX;
          clonedBox.x2 += originX;
          clonedBox.y += originY;
          clonedBox.y2 += originY;
        });

        allBoxes[c] = clonedBoxes;
        $("." + c).remove();
        _.each(boxes, function(box) {
          var div = $("<div></div>");
          div.mousedown(function() {
            currentMovingClass = c;
          });
          div.mousemove(function(e) {
            var diffY = currentMousePos.top - lastMousePos.top;
            var diffX = currentMousePos.left - lastMousePos.left;
            if(currentMovingClass) {
              _.each(allBoxes[currentMovingClass], function(playerBox) {
                playerBox.y = playerBox.y + diffY;
                playerBox.y2 = playerBox.y2 + diffY;
                playerBox.x = playerBox.x + diffX;
                playerBox.x2 = playerBox.x2 + diffX;
              });

              $("." + currentMovingClass).each(function() {
                var element = $(this);
                var pos = element.position();
                element.css({ top: pos.top + diffY });
                element.css({ left: pos.left + diffX });
                var theRest = [ ];
                for(var b in allBoxes) {
                  if(b != c) {
                    theRest.push(allBoxes[b]);
                  }
                }

                if(c === "lk" || c == "rk") { isDeath(_.last(allBoxes[c]), theRest); }
              });
            }
          });
          div.addClass(c);
          div.css({
            border: "solid 1px black",
            position: "absolute",
            left: originX + box.x,
            top: originY + box.y,
            width: Math.abs(box.x2 - box.x)  + "px",
            height: Math.abs(box.y2 - box.y) + "px" });
          $("body").append(div);
        });
      }

      function jump(player) {
        if(player.s === "s") {
          player.dy = dy;
          player.s = "j";
        }
      }

      function tick() {
        ticks += 1;
        applyGravity(player);
        applyKick(player);
        setSquare(player.x, player.y);
      }
    </script>
  </body>
</html>
